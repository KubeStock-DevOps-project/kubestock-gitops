# Secret Management

This document describes the secret management architecture for KubeStock.

## Architecture Overview

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           GitHub Secrets                                     │
│  (ASGARDEO_*, SLACK_*, TEST_RUNNER_*, DB_PASSWORD)                          │
└───────────────────────────────┬─────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                        terraform.tfvars                                      │
│  (Generated by GitHub Actions workflow)                                     │
└───────────────────────────────┬─────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         Terraform                                            │
│  - Creates secrets in AWS Secrets Manager                                   │
│  - Populates values from tfvars                                             │
│  - Creates IAM users for access                                             │
└───────────────────────────────┬─────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                    AWS Secrets Manager                                       │
│  kubestock/production/db                                                    │
│  kubestock/staging/db                                                       │
│  kubestock/production/asgardeo                                              │
│  kubestock/staging/asgardeo                                                 │
│  kubestock/production/alertmanager/slack                                    │
│  kubestock/shared/test-runner                                               │
│  kubestock/shared/ecr-credentials                                           │
└───────────────────────────────┬─────────────────────────────────────────────┘
                                │
              ┌─────────────────┴─────────────────┐
              │                                   │
              ▼                                   ▼
┌──────────────────────────┐       ┌──────────────────────────┐
│  kubestock-external-     │       │  kubestock-ecr-pull      │
│  secrets (IAM User)      │       │  (IAM User)              │
│  - Manual access key     │       │  - Credentials in SM     │
│  - Bootstrap ESO         │       │  - Synced by ESO         │
└───────────┬──────────────┘       └──────────────────────────┘
            │
            ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│               External Secrets Operator (ESO)                                │
│  ClusterSecretStore: aws-secretsmanager                                     │
│  Namespace: external-secrets                                                │
└───────────────────────────────┬─────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                    Kubernetes Secrets                                        │
│  (Synced to each namespace)                                                 │
│  - db-credentials                                                           │
│  - asgardeo-credentials                                                     │
│  - ecr-credentials (dockerconfigjson)                                       │
│  - alertmanager-slack (observability only)                                  │
└─────────────────────────────────────────────────────────────────────────────┘
```

## IAM Users

### kubestock-external-secrets
**Purpose**: Bootstrap credentials for External Secrets Operator

**Permissions**:
- `secretsmanager:GetSecretValue` - Read secrets from AWS SM
- `secretsmanager:DescribeSecret` - Describe secrets
- `ecr:GetAuthorizationToken` - Generate ECR auth tokens
- `ecr:BatchGetImage`, etc. - Pull ECR images

**Access Key Management**:
- Created **manually** via AWS CLI (not stored in Terraform state)
- Stored as Kubernetes secret `aws-external-secrets-creds` in `external-secrets` namespace

### kubestock-ecr-pull
**Purpose**: ECR image pull credentials stored in Secrets Manager

**Permissions**:
- `ecr:GetAuthorizationToken` - Generate ECR auth tokens
- `ecr:BatchGetImage`, etc. - Pull ECR images

**Access Key Management**:
- Created by Terraform
- Stored in AWS Secrets Manager at `kubestock/shared/ecr-credentials`
- Synced by ESO to all namespaces as `ecr-credentials` secret

## AWS Secrets Manager Structure

| Secret Path | Environment | Contents |
|-------------|-------------|----------|
| `kubestock/production/db` | Production | DB_HOST, DB_USER, DB_PASSWORD, DB_NAME |
| `kubestock/staging/db` | Staging | DB_HOST, DB_USER, DB_PASSWORD, DB_NAME |
| `kubestock/production/asgardeo` | Production | 12 Asgardeo OAuth fields |
| `kubestock/staging/asgardeo` | Staging | 12 Asgardeo OAuth fields |
| `kubestock/production/alertmanager/slack` | Production | default-url, critical-url, warning-url |
| `kubestock/shared/test-runner` | Shared | client_id, client_secret, username, password |
| `kubestock/shared/ecr-credentials` | Shared | AWS_ACCESS_KEY_ID, AWS_SECRET_ACCESS_KEY |

## Kubernetes Secrets by Namespace

| Namespace | Secret Name | Source | Type |
|-----------|-------------|--------|------|
| `kubestock-production` | `db-credentials` | kubestock/production/db | Opaque |
| `kubestock-production` | `asgardeo-credentials` | kubestock/production/asgardeo | Opaque |
| `kubestock-production` | `ecr-credentials` | ECRAuthorizationToken | dockerconfigjson |
| `kubestock-staging` | `db-credentials` | kubestock/staging/db | Opaque |
| `kubestock-staging` | `asgardeo-credentials` | kubestock/staging/asgardeo | Opaque |
| `kubestock-staging` | `ecr-credentials` | ECRAuthorizationToken | dockerconfigjson |
| `observability-production` | `alertmanager-slack` | kubestock/production/alertmanager/slack | Opaque |
| `test-runner` | `test-credentials` | kubestock/shared/test-runner | Opaque |

## Bootstrap Procedure

### 1. Prerequisites
- Terraform applied with all secrets in AWS Secrets Manager
- External Secrets Operator installed in cluster
- `external-secrets` namespace exists

### 2. Create ESO Bootstrap Secret

```bash
# Create access key for kubestock-external-secrets IAM user
aws iam create-access-key --user-name kubestock-external-secrets

# Note the AccessKeyId and SecretAccessKey from output
# Create Kubernetes secret
kubectl create secret generic aws-external-secrets-creds \
  --from-literal=access-key-id=AKIAXXXXXXXX \
  --from-literal=secret-access-key=XXXXXXXX \
  --namespace=external-secrets
```

### 3. Apply ClusterSecretStore

```bash
kubectl apply -f gitops/base/external-secrets/cluster-secret-store.yaml
```

### 4. Verify

```bash
# Check ClusterSecretStore is ready
kubectl get clustersecretstore aws-secretsmanager

# Check ExternalSecrets are syncing
kubectl get externalsecrets -A

# Verify secrets exist
kubectl get secrets -n kubestock-production
kubectl get secrets -n kubestock-staging
```

## Terraform Module Structure

```
infrastructure/terraform/prod/modules/
├── secrets/
│   ├── main.tf          # Secrets + IAM user for ESO
│   ├── variables.tf     # Input variables
│   ├── outputs.tf       # Secret ARNs + IAM user info
│   └── README.md        # Module documentation
└── ecr/
    └── main.tf          # ECR repos + ecr-pull IAM user
```

## Secret Rotation

### Database Credentials
1. Update `db_password` in GitHub Secrets
2. Run Terraform to update AWS Secrets Manager
3. ESO automatically syncs to Kubernetes (1-minute refresh)
4. Pods pick up new credentials on restart

### Asgardeo Credentials
1. Rotate credentials in Asgardeo console
2. Update corresponding GitHub Secrets
3. Run Terraform to update AWS Secrets Manager
4. ESO automatically syncs to Kubernetes

### ECR Credentials
- `kubestock-ecr-pull` access key is managed by Terraform
- To rotate: `terraform taint 'module.ecr.aws_iam_access_key.ecr_pull'` then apply
- ESO automatically syncs new credentials

### ESO Bootstrap Credentials
- `kubestock-external-secrets` access key is created manually
- To rotate:
  1. Create new access key: `aws iam create-access-key --user-name kubestock-external-secrets`
  2. Update Kubernetes secret: `kubectl edit secret aws-external-secrets-creds -n external-secrets`
  3. Delete old access key: `aws iam delete-access-key --user-name kubestock-external-secrets --access-key-id OLD_KEY`

## Troubleshooting

### ESO Not Syncing
```bash
# Check ClusterSecretStore status
kubectl describe clustersecretstore aws-secretsmanager

# Check ExternalSecret status
kubectl describe externalsecret <name> -n <namespace>

# Check ESO operator logs
kubectl logs -n external-secrets -l app.kubernetes.io/name=external-secrets
```

### Invalid Credentials
```bash
# Verify IAM user exists
aws iam get-user --user-name kubestock-external-secrets

# Verify secret has correct keys
aws secretsmanager get-secret-value --secret-id kubestock/production/db | jq '.SecretString | fromjson | keys'

# Test credentials manually
AWS_ACCESS_KEY_ID=xxx AWS_SECRET_ACCESS_KEY=xxx aws secretsmanager get-secret-value --secret-id kubestock/production/db
```
