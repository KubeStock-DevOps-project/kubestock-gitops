apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: kubestock-routes
  namespace: istio-system
spec:
  hosts:
    - "*"
  gateways:
    - kubestock-gateway
  http:
    # Health endpoint for ALB (must be before service routes)
    - match:
        - uri:
            exact: /api/gateway/health
      directResponse:
        status: 200
        body:
          string: '{"status":"healthy","gateway":"istio"}'

    # Product Service - regex to preserve subpath
    # /api/product/health -> /health, /api/product -> /
    - match:
        - uri:
            prefix: /api/product
      rewrite:
        uriRegexRewrite:
          match: ^/api/product(/.*)?$
          rewrite: \1
      route:
        - destination:
            host: ms-product.kubestock-staging.svc.kubestock
            port:
              number: 3002
      corsPolicy:
        allowOrigins:
          - regex: ".*"
        allowMethods:
          - GET
          - POST
          - PUT
          - PATCH
          - DELETE
          - OPTIONS
        allowHeaders:
          - Authorization
          - Content-Type
          - Accept
          - X-Request-ID
        allowCredentials: true
        maxAge: "3600s"

    # Inventory Service
    - match:
        - uri:
            prefix: /api/inventory
      rewrite:
        uriRegexRewrite:
          match: ^/api/inventory(/.*)?$
          rewrite: \1
      route:
        - destination:
            host: ms-inventory.kubestock-staging.svc.kubestock
            port:
              number: 3003
      corsPolicy:
        allowOrigins:
          - regex: ".*"
        allowMethods:
          - GET
          - POST
          - PUT
          - PATCH
          - DELETE
          - OPTIONS
        allowHeaders:
          - Authorization
          - Content-Type
          - Accept
          - X-Request-ID
        allowCredentials: true
        maxAge: "3600s"

    # Supplier Service
    - match:
        - uri:
            prefix: /api/supplier
      rewrite:
        uriRegexRewrite:
          match: ^/api/supplier(/.*)?$
          rewrite: \1
      route:
        - destination:
            host: ms-supplier.kubestock-staging.svc.kubestock
            port:
              number: 3004
      corsPolicy:
        allowOrigins:
          - regex: ".*"
        allowMethods:
          - GET
          - POST
          - PUT
          - PATCH
          - DELETE
          - OPTIONS
        allowHeaders:
          - Authorization
          - Content-Type
          - Accept
          - X-Request-ID
        allowCredentials: true
        maxAge: "3600s"

    # Order Management Service
    - match:
        - uri:
            prefix: /api/order
      rewrite:
        uriRegexRewrite:
          match: ^/api/order(/.*)?$
          rewrite: \1
      route:
        - destination:
            host: ms-order-management.kubestock-staging.svc.kubestock
            port:
              number: 3005
      corsPolicy:
        allowOrigins:
          - regex: ".*"
        allowMethods:
          - GET
          - POST
          - PUT
          - PATCH
          - DELETE
          - OPTIONS
        allowHeaders:
          - Authorization
          - Content-Type
          - Accept
          - X-Request-ID
        allowCredentials: true
        maxAge: "3600s"

    # Identity Service
    - match:
        - uri:
            prefix: /api/identity
      rewrite:
        uriRegexRewrite:
          match: ^/api/identity(/.*)?$
          rewrite: \1
      route:
        - destination:
            host: ms-identity.kubestock-staging.svc.kubestock
            port:
              number: 3006
      corsPolicy:
        allowOrigins:
          - regex: ".*"
        allowMethods:
          - GET
          - POST
          - PUT
          - PATCH
          - DELETE
          - OPTIONS
        allowHeaders:
          - Authorization
          - Content-Type
          - Accept
          - X-Request-ID
        allowCredentials: true
        maxAge: "3600s"

    # Frontend (catch-all)
    - match:
        - uri:
            prefix: /
      route:
        - destination:
            host: frontend.kubestock-staging.svc.kubestock
            port:
              number: 80
