# =============================================================================
# Gateway-level JWT Guardrail
# =============================================================================
# This is a first-line defense at the Istio ingress gateway.
# It checks:
# 1. JWT exists in Authorization header
# 2. Basic JWT validation (iss, aud claims) - does NOT verify signature
# 
# The actual signature verification happens at the sidecar level using
# Asgardeo's JWKS endpoint (see request-authentication.yaml)
# =============================================================================
apiVersion: security.istio.io/v1beta1
kind: RequestAuthentication
metadata:
  name: gateway-jwt-guard
  namespace: istio-system
spec:
  selector:
    matchLabels:
      istio: ingressgateway
  jwtRules:
    - issuer: "https://api.asgardeo.io/t/kubestock/oauth2/token"
      # Use JWKS for full validation - Istio caches the JWKS
      jwksUri: "https://api.asgardeo.io/t/kubestock/oauth2/jwks"
      audiences:
        - "NydMISKZZ5TdIEuRwJfYv62Yn7ka"  # SPA Application
        - "6e6DeVI9oNaoYV6SSi7cWjIckMQa"  # Test Runner Application
      # Forward the token to upstream services
      forwardOriginalToken: true
---
# Authorization Policy at gateway to require JWT for API routes
# Allows: frontend routes, health endpoints, OPTIONS (CORS)
# Denies: API routes without valid JWT
apiVersion: security.istio.io/v1beta1
kind: AuthorizationPolicy
metadata:
  name: gateway-require-jwt
  namespace: istio-system
spec:
  selector:
    matchLabels:
      istio: ingressgateway
  action: DENY
  rules:
    # Deny API requests without valid JWT
    - from:
        - source:
            notRequestPrincipals: ["*"]
      to:
        - operation:
            # Match API paths that require JWT
            paths:
              - "/api/product*"
              - "/api/inventory*"
              - "/api/supplier*"
              - "/api/order*"
            # Don't deny OPTIONS (CORS preflight)
            notMethods: ["OPTIONS"]
