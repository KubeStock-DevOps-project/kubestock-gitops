# =============================================================================
# Kong Declarative Configuration
# =============================================================================
# Simple routing: /api/{service}/* → strips prefix → backend service
# Base config - CORS origins patched per environment (staging: *, prod: domain)
# =============================================================================
apiVersion: v1
kind: ConfigMap
metadata:
  name: kong-declarative-config
  namespace: kong
data:
  kong.yml: |
    _format_version: "3.0"

    # ==========================================================================
    # Consumers - API Clients
    # ==========================================================================
    consumers:
      - username: test-runner
        custom_id: test-runner-service

    # ==========================================================================
    # Services - Backend Microservices
    # ==========================================================================
    # Routing pattern: /api/{service}/* → service (prefix stripped)
    # ==========================================================================

    services:
      # ------------------------------------------------------------------------
      # Product Catalog Service: /api/product/*
      # ------------------------------------------------------------------------
      - name: ms-product
        url: http://ms-product.kubestock-staging.svc.kubestock:3002
        routes:
          - name: product-routes
            paths:
              - /api/product
            strip_path: true
            protocols:
              - http
              - https
        plugins:
          - name: rate-limiting
            config:
              minute: 200
              policy: local
          - name: cors
            config:
              origins:
                - "*"
              methods:
                - GET
                - POST
                - PUT
                - PATCH
                - DELETE
                - OPTIONS
              headers:
                - Accept
                - Authorization
                - Content-Type
                - X-Request-ID
              credentials: true
              max_age: 3600
          - name: prometheus

      # ------------------------------------------------------------------------
      # Inventory Service: /api/inventory/*
      # ------------------------------------------------------------------------
      - name: ms-inventory
        url: http://ms-inventory.kubestock-staging.svc.kubestock:3003
        routes:
          - name: inventory-routes
            paths:
              - /api/inventory
            strip_path: true
            protocols:
              - http
              - https
        plugins:
          - name: rate-limiting
            config:
              minute: 200
              policy: local
          - name: cors
            config:
              origins:
                - "*"
              methods:
                - GET
                - POST
                - PUT
                - PATCH
                - DELETE
                - OPTIONS
              headers:
                - Accept
                - Authorization
                - Content-Type
                - X-Request-ID
              credentials: true
              max_age: 3600
          - name: prometheus

      # ------------------------------------------------------------------------
      # Supplier Service: /api/supplier/*
      # ------------------------------------------------------------------------
      - name: ms-supplier
        url: http://ms-supplier.kubestock-staging.svc.kubestock:3004
        routes:
          - name: supplier-routes
            paths:
              - /api/supplier
            strip_path: true
            protocols:
              - http
              - https
        plugins:
          - name: rate-limiting
            config:
              minute: 100
              policy: local
          - name: cors
            config:
              origins:
                - "*"
              methods:
                - GET
                - POST
                - PUT
                - PATCH
                - DELETE
                - OPTIONS
              headers:
                - Accept
                - Authorization
                - Content-Type
                - X-Request-ID
              credentials: true
              max_age: 3600
          - name: prometheus

      # ------------------------------------------------------------------------
      # Order Management Service: /api/order/*
      # ------------------------------------------------------------------------
      - name: ms-order-management
        url: http://ms-order-management.kubestock-staging.svc.kubestock:3005
        routes:
          - name: order-routes
            paths:
              - /api/order
            strip_path: true
            protocols:
              - http
              - https
        plugins:
          - name: rate-limiting
            config:
              minute: 150
              policy: local
          - name: cors
            config:
              origins:
                - "*"
              methods:
                - GET
                - POST
                - PUT
                - PATCH
                - DELETE
                - OPTIONS
              headers:
                - Accept
                - Authorization
                - Content-Type
                - X-Request-ID
              credentials: true
              max_age: 3600
          - name: prometheus

      # ------------------------------------------------------------------------
      # Identity Service: /api/identity/*
      # ------------------------------------------------------------------------
      - name: ms-identity
        url: http://ms-identity.kubestock-staging.svc.kubestock:3006
        routes:
          - name: identity-routes
            paths:
              - /api/identity
            strip_path: true
            protocols:
              - http
              - https
        plugins:
          - name: rate-limiting
            config:
              minute: 100
              policy: local
          - name: cors
            config:
              origins:
                - "*"
              methods:
                - GET
                - POST
                - PUT
                - PATCH
                - DELETE
                - OPTIONS
              headers:
                - Accept
                - Authorization
                - Content-Type
                - X-Request-ID
              credentials: true
              max_age: 3600
          - name: prometheus

      # ------------------------------------------------------------------------
      # Frontend Static Assets: /*
      # ------------------------------------------------------------------------
      - name: frontend
        url: http://frontend.kubestock-staging.svc.kubestock:80
        routes:
          - name: frontend-routes
            paths:
              - /
            strip_path: false
            protocols:
              - http
              - https
        plugins:
          - name: prometheus

      # ------------------------------------------------------------------------
      # Health Check Endpoint: /api/gateway/health
      # ------------------------------------------------------------------------
      - name: health
        url: http://localhost:8001/status
        routes:
          - name: health-route
            paths:
              - /api/gateway/health
            strip_path: true
