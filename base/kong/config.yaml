# =============================================================================
# Kong Declarative Configuration
# =============================================================================
# Base config - CORS origins will be patched per environment
# Staging: * (wildcard)
# Production: kubestock.dpiyumal.me, api.dpiyumal.me
# =============================================================================
apiVersion: v1
kind: ConfigMap
metadata:
  name: kong-declarative-config
  namespace: kong
data:
  kong.yml: |
    _format_version: "3.0"

    # ==========================================================================
    # Services - Backend Microservices
    # ==========================================================================

    services:
      # ------------------------------------------------------------------------
      # Product Catalog Service
      # ------------------------------------------------------------------------
      - name: ms-product
        url: http://ms-product.kubestock-staging.svc.kubestock:3002
        routes:
          - name: product-routes
            paths:
              - /api/products
              - /api/categories
              - /api/pricing
            strip_path: false
            protocols:
              - http
              - https
        plugins:
          - name: rate-limiting
            config:
              minute: 200
              policy: local
          - name: cors
            config:
              origins:
                - "*"
              methods:
                - GET
                - POST
                - PUT
                - PATCH
                - DELETE
                - OPTIONS
              headers:
                - Accept
                - Authorization
                - Content-Type
                - X-Request-ID
              credentials: true
              max_age: 3600
          - name: prometheus

      # ------------------------------------------------------------------------
      # Inventory Service
      # ------------------------------------------------------------------------
      - name: ms-inventory
        url: http://ms-inventory.kubestock-staging.svc.kubestock:3003
        routes:
          - name: inventory-routes
            paths:
              - /api/inventory
              - /api/stock
              - /api/alerts
            strip_path: false
            protocols:
              - http
              - https
        plugins:
          - name: rate-limiting
            config:
              minute: 200
              policy: local
          - name: cors
            config:
              origins:
                - "*"
              methods:
                - GET
                - POST
                - PUT
                - PATCH
                - DELETE
                - OPTIONS
              headers:
                - Accept
                - Authorization
                - Content-Type
                - X-Request-ID
              credentials: true
              max_age: 3600
          - name: prometheus

      # ------------------------------------------------------------------------
      # Supplier Service
      # ------------------------------------------------------------------------
      - name: ms-supplier
        url: http://ms-supplier.kubestock-staging.svc.kubestock:3004
        routes:
          - name: supplier-routes
            paths:
              - /api/suppliers
              - /api/purchase-orders
            strip_path: false
            protocols:
              - http
              - https
        plugins:
          - name: rate-limiting
            config:
              minute: 100
              policy: local
          - name: cors
            config:
              origins:
                - "*"
              methods:
                - GET
                - POST
                - PUT
                - PATCH
                - DELETE
                - OPTIONS
              headers:
                - Accept
                - Authorization
                - Content-Type
                - X-Request-ID
              credentials: true
              max_age: 3600
          - name: prometheus

      # ------------------------------------------------------------------------
      # Order Management Service
      # ------------------------------------------------------------------------
      - name: ms-order-management
        url: http://ms-order-management.kubestock-staging.svc.kubestock:3005
        routes:
          - name: order-routes
            paths:
              - /api/orders
            strip_path: false
            protocols:
              - http
              - https
        plugins:
          - name: rate-limiting
            config:
              minute: 150
              policy: local
          - name: cors
            config:
              origins:
                - "*"
              methods:
                - GET
                - POST
                - PUT
                - PATCH
                - DELETE
                - OPTIONS
              headers:
                - Accept
                - Authorization
                - Content-Type
                - X-Request-ID
              credentials: true
              max_age: 3600
          - name: prometheus

      # ------------------------------------------------------------------------
      # Identity Service (Asgardeo SCIM2 Proxy)
      # ------------------------------------------------------------------------
      - name: ms-identity
        url: http://ms-identity.kubestock-staging.svc.kubestock:3006
        routes:
          - name: identity-routes
            paths:
              - /api/identity
              - /api/users
              - /api/groups
              - /api/roles
            strip_path: false
            protocols:
              - http
              - https
        plugins:
          - name: rate-limiting
            config:
              minute: 100
              policy: local
          - name: cors
            config:
              origins:
                - "*"
              methods:
                - GET
                - POST
                - PUT
                - PATCH
                - DELETE
                - OPTIONS
              headers:
                - Accept
                - Authorization
                - Content-Type
                - X-Request-ID
              credentials: true
              max_age: 3600
          - name: prometheus

      # ------------------------------------------------------------------------
      # Frontend Static Assets
      # ------------------------------------------------------------------------
      - name: frontend
        url: http://frontend.kubestock-staging.svc.kubestock:80
        routes:
          - name: frontend-routes
            paths:
              - /
            strip_path: false
            protocols:
              - http
              - https
        plugins:
          - name: prometheus

      # ------------------------------------------------------------------------
      # Health Check Endpoint
      # ------------------------------------------------------------------------
      - name: health
        url: http://localhost:8001/status
        routes:
          - name: health-route
            paths:
              - /health
            strip_path: true
