# =============================================================================
# Observability Stack - Staging Overlay
# =============================================================================
# Completely isolated staging observability:
# - Namespace: observability-staging
# - NodePorts: 31090 (Prometheus), 31300 (Grafana)
# - Prometheus scrapes: kubestock-staging namespace
# - Unique ClusterRole names to avoid conflicts
# =============================================================================
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: observability-staging

resources:
  - ../../../base/observability-stack/

labels:
  - pairs:
      environment: staging
    includeSelectors: false

# Patches for staging-specific configuration
patches:
  # Namespace name
  - patch: |-
      - op: replace
        path: /metadata/name
        value: observability-staging
    target:
      kind: Namespace
      name: observability

  # Prometheus service - staging NodePort
  - patch: |-
      - op: replace
        path: /spec/ports/0/nodePort
        value: 31090
    target:
      kind: Service
      name: prometheus

  # Grafana service - staging NodePort
  - patch: |-
      - op: replace
        path: /spec/ports/0/nodePort
        value: 31300
    target:
      kind: Service
      name: grafana

  # Rename ClusterRole for prometheus to avoid conflicts
  - patch: |-
      - op: replace
        path: /metadata/name
        value: prometheus-staging
    target:
      kind: ClusterRole
      name: prometheus

  # Rename ClusterRoleBinding for prometheus
  - patch: |-
      - op: replace
        path: /metadata/name
        value: prometheus-staging
      - op: replace
        path: /roleRef/name
        value: prometheus-staging
      - op: replace
        path: /subjects/0/namespace
        value: observability-staging
    target:
      kind: ClusterRoleBinding
      name: prometheus

  # Rename ClusterRole for promtail
  - patch: |-
      - op: replace
        path: /metadata/name
        value: promtail-staging
    target:
      kind: ClusterRole
      name: promtail

  # Rename ClusterRoleBinding for promtail
  - patch: |-
      - op: replace
        path: /metadata/name
        value: promtail-staging
      - op: replace
        path: /roleRef/name
        value: promtail-staging
      - op: replace
        path: /subjects/0/namespace
        value: observability-staging
    target:
      kind: ClusterRoleBinding
      name: promtail

  # Rename ClusterRole for kube-state-metrics
  - patch: |-
      - op: replace
        path: /metadata/name
        value: kube-state-metrics-staging
    target:
      kind: ClusterRole
      name: kube-state-metrics

  # Rename ClusterRoleBinding for kube-state-metrics
  - patch: |-
      - op: replace
        path: /metadata/name
        value: kube-state-metrics-staging
      - op: replace
        path: /roleRef/name
        value: kube-state-metrics-staging
      - op: replace
        path: /subjects/0/namespace
        value: observability-staging
    target:
      kind: ClusterRoleBinding
      name: kube-state-metrics

  # Prometheus config - staging scrape targets
  - path: prometheus-config.yaml

# Replace images if needed (same versions for now)
images:
  - name: prom/prometheus
    newTag: v2.48.0
  - name: grafana/grafana
    newTag: "10.2.3"
  - name: grafana/loki
    newTag: "2.9.3"
  - name: grafana/promtail
    newTag: "2.9.3"
