# =============================================================================
# Staging Overlay - kubestock-staging namespace
# =============================================================================
# Rolling Update Deployment Strategy
# Uses RDS PostgreSQL for database
# Uses specific SHA tags managed by CI/CD pipeline
# CORS: * (wildcard)
# =============================================================================
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: kubestock-staging

resources:
- ../../base/services/ms-product/
- ../../base/services/ms-inventory/
- ../../base/services/ms-supplier/
- ../../base/services/ms-order-management/
- ../../base/services/ms-identity/
- ../../base/services/frontend/
- namespace.yaml
- external-secrets.yaml

labels:
- pairs:
    environment: staging

# Image tags - using specific SHA tags (updated by CI/CD)
images:
- name: 478468757808.dkr.ecr.ap-south-1.amazonaws.com/frontend
  newTag: latest
- name: 478468757808.dkr.ecr.ap-south-1.amazonaws.com/ms-identity
  newName: 478468757808.dkr.ecr.ap-south-1.amazonaws.com/ms-identity
  newTag: 9a98bb1
- name: 478468757808.dkr.ecr.ap-south-1.amazonaws.com/ms-inventory
  newName: 478468757808.dkr.ecr.ap-south-1.amazonaws.com/ms-inventory
  newTag: f7d1163
- name: 478468757808.dkr.ecr.ap-south-1.amazonaws.com/ms-order-management
  newName: 478468757808.dkr.ecr.ap-south-1.amazonaws.com/ms-order-management
  newTag: c80a464
- name: 478468757808.dkr.ecr.ap-south-1.amazonaws.com/ms-product
  newName: 478468757808.dkr.ecr.ap-south-1.amazonaws.com/ms-product
  newTag: bf69b19
- name: 478468757808.dkr.ecr.ap-south-1.amazonaws.com/ms-supplier
  newName: 478468757808.dkr.ecr.ap-south-1.amazonaws.com/ms-supplier
  newTag: "5699976"

# Patches for staging-specific configuration
  # Reduce replicas for staging
patches:
- patch: |-
    - op: replace
      path: /spec/replicas
      value: 1
  target:
    kind: Deployment
