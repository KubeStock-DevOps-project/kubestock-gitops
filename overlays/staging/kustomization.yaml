# =============================================================================
# Staging Overlay - kubestock-staging namespace
# =============================================================================
# Rolling Update Deployment Strategy
# Uses RDS PostgreSQL for database
# Uses specific SHA tags managed by CI/CD pipeline
# CORS: * (wildcard for staging)
# =============================================================================
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: kubestock-staging

resources:
- ../../base/services/ms-product/
- ../../base/services/ms-inventory/
- ../../base/services/ms-supplier/
- ../../base/services/ms-order-management/
- ../../base/services/ms-identity/
- ../../base/services/frontend/
- namespace.yaml
- external-secrets.yaml

labels:
- pairs:
    environment: staging

# Image tags - using specific SHA tags (updated by CI/CD)
images:
- name: 478468757808.dkr.ecr.ap-south-1.amazonaws.com/kubestock/web
  newTag: f66c2e6cb0d5685bb19120e4fce528b379109185
- name: 478468757808.dkr.ecr.ap-south-1.amazonaws.com/kubestock/ms-identity
  newTag: f66c2e6cb0d5685bb19120e4fce528b379109185
- name: 478468757808.dkr.ecr.ap-south-1.amazonaws.com/kubestock/ms-inventory
  newTag: f66c2e6cb0d5685bb19120e4fce528b379109185
- name: 478468757808.dkr.ecr.ap-south-1.amazonaws.com/kubestock/ms-order-management
  newTag: f66c2e6cb0d5685bb19120e4fce528b379109185
- name: 478468757808.dkr.ecr.ap-south-1.amazonaws.com/kubestock/ms-product
  newTag: f66c2e6cb0d5685bb19120e4fce528b379109185
- name: 478468757808.dkr.ecr.ap-south-1.amazonaws.com/kubestock/ms-supplier
  newTag: f66c2e6cb0d5685bb19120e4fce528b379109185

# Patches for staging-specific configuration
patches:
  # Reduce replicas for staging
  - patch: |-
      - op: replace
        path: /spec/replicas
        value: 1
    target:
      kind: Deployment
  
  # Frontend environment variables for staging (internal access via bastion)
  - patch: |-
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: VITE_APP_URL
          value: ""
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: VITE_API_GATEWAY_URL
          value: ""
    target:
      kind: Deployment
      name: frontend
