# =============================================================================
# Kong Configuration for Staging
# =============================================================================
# Routes /api/* to kubestock-staging services
# CORS: * (wildcard for staging)
# =============================================================================
apiVersion: v1
kind: ConfigMap
metadata:
  name: kong-declarative-config
data:
  kong.yml: |
    _format_version: "3.0"

    services:
      # Product: /api/product/* → ms-product
      - name: ms-product
        url: http://ms-product.kubestock-staging.svc.cluster.local:3002
        routes:
          - name: product-routes
            paths:
              - /api/product
            strip_path: true
            protocols:
              - http
              - https
        plugins:
          - name: rate-limiting
            config:
              minute: 200
              policy: local
          - name: cors
            config:
              origins:
                - "*"
              methods:
                - GET
                - POST
                - PUT
                - PATCH
                - DELETE
                - OPTIONS
              headers:
                - Accept
                - Authorization
                - Content-Type
                - X-Request-ID
              credentials: true
              max_age: 3600
          - name: prometheus

      # Inventory: /api/inventory/* → ms-inventory
      - name: ms-inventory
        url: http://ms-inventory.kubestock-staging.svc.cluster.local:3003
        routes:
          - name: inventory-routes
            paths:
              - /api/inventory
            strip_path: true
            protocols:
              - http
              - https
        plugins:
          - name: rate-limiting
            config:
              minute: 200
              policy: local
          - name: cors
            config:
              origins:
                - "*"
              methods:
                - GET
                - POST
                - PUT
                - PATCH
                - DELETE
                - OPTIONS
              headers:
                - Accept
                - Authorization
                - Content-Type
                - X-Request-ID
              credentials: true
              max_age: 3600
          - name: prometheus

      # Supplier: /api/supplier/* → ms-supplier
      - name: ms-supplier
        url: http://ms-supplier.kubestock-staging.svc.cluster.local:3004
        routes:
          - name: supplier-routes
            paths:
              - /api/supplier
            strip_path: true
            protocols:
              - http
              - https
        plugins:
          - name: rate-limiting
            config:
              minute: 100
              policy: local
          - name: cors
            config:
              origins:
                - "*"
              methods:
                - GET
                - POST
                - PUT
                - PATCH
                - DELETE
                - OPTIONS
              headers:
                - Accept
                - Authorization
                - Content-Type
                - X-Request-ID
              credentials: true
              max_age: 3600
          - name: prometheus

      # Order Management: /api/order/* → ms-order-management
      - name: ms-order-management
        url: http://ms-order-management.kubestock-staging.svc.cluster.local:3005
        routes:
          - name: order-routes
            paths:
              - /api/order
            strip_path: true
            protocols:
              - http
              - https
        plugins:
          - name: rate-limiting
            config:
              minute: 150
              policy: local
          - name: cors
            config:
              origins:
                - "*"
              methods:
                - GET
                - POST
                - PUT
                - PATCH
                - DELETE
                - OPTIONS
              headers:
                - Accept
                - Authorization
                - Content-Type
                - X-Request-ID
              credentials: true
              max_age: 3600
          - name: prometheus

      # Identity: /api/identity/* → ms-identity
      - name: ms-identity
        url: http://ms-identity.kubestock-staging.svc.cluster.local:3006
        routes:
          - name: identity-routes
            paths:
              - /api/identity
            strip_path: true
            protocols:
              - http
              - https
        plugins:
          - name: rate-limiting
            config:
              minute: 100
              policy: local
          - name: cors
            config:
              origins:
                - "*"
              methods:
                - GET
                - POST
                - PUT
                - PATCH
                - DELETE
                - OPTIONS
              headers:
                - Accept
                - Authorization
                - Content-Type
                - X-Request-ID
              credentials: true
              max_age: 3600
          - name: prometheus

      # Frontend: /* → frontend
      - name: frontend
        url: http://frontend.kubestock-staging.svc.cluster.local:80
        routes:
          - name: frontend-routes
            paths:
              - /
            strip_path: false
            protocols:
              - http
              - https
        plugins:
          - name: prometheus

      # Health Check: /api/gateway/health
      - name: health
        url: http://localhost:8001/status
        routes:
          - name: health-route
            paths:
              - /api/gateway/health
            strip_path: true
