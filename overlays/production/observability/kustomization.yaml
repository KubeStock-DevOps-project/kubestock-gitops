# =============================================================================
# Observability Overlay - Production
# =============================================================================
# Production-grade configuration
# - Longer retention periods (15 days local, S3 for long-term)
# - Higher resource limits
# - Alerting enabled
# =============================================================================
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: observability

resources:
  - ../../../base/observability/
  - alertmanager/

labels:
  - pairs:
      environment: production
    includeSelectors: false

# Production-specific patches
patches:
  # Prometheus - production configuration
  - patch: |-
      - op: replace
        path: /spec/template/spec/containers/0/args
        value:
          - '--config.file=/etc/prometheus/prometheus.yml'
          - '--storage.tsdb.path=/prometheus'
          - '--storage.tsdb.retention.time=15d'
          - '--storage.tsdb.retention.size=8GB'
          - '--web.console.libraries=/usr/share/prometheus/console_libraries'
          - '--web.console.templates=/usr/share/prometheus/consoles'
          - '--web.enable-lifecycle'
          - '--web.enable-admin-api'
      - op: replace
        path: /spec/template/spec/containers/0/resources
        value:
          requests:
            cpu: 200m
            memory: 512Mi
          limits:
            cpu: 1000m
            memory: 2Gi
    target:
      kind: Deployment
      name: prometheus

  # Grafana - production configuration
  - patch: |-
      - op: replace
        path: /spec/template/spec/containers/0/resources
        value:
          requests:
            cpu: 100m
            memory: 256Mi
          limits:
            cpu: 500m
            memory: 512Mi
    target:
      kind: Deployment
      name: grafana

  # Loki - production configuration
  - patch: |-
      - op: replace
        path: /spec/template/spec/containers/0/resources
        value:
          requests:
            cpu: 100m
            memory: 256Mi
          limits:
            cpu: 500m
            memory: 1Gi
    target:
      kind: Deployment
      name: loki

  # Production PVC sizes
  - patch: |-
      - op: replace
        path: /spec/resources/requests/storage
        value: 10Gi
    target:
      kind: PersistentVolumeClaim
      name: prometheus-storage

  - patch: |-
      - op: replace
        path: /spec/resources/requests/storage
        value: 5Gi
    target:
      kind: PersistentVolumeClaim
      name: grafana-storage

  - patch: |-
      - op: replace
        path: /spec/resources/requests/storage
        value: 10Gi
    target:
      kind: PersistentVolumeClaim
      name: loki-storage

  # Prometheus config - production namespace scraping
  - path: prometheus-config.yaml
    target:
      kind: ConfigMap
      name: prometheus-config
