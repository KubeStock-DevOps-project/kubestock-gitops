apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: kubestock-routes
  namespace: istio-system
spec:
  hosts:
    - "*"
  gateways:
    - kubestock-gateway
  http:
    - match:
        - uri:
            prefix: /api/product
      rewrite:
        uri: /
      route:
        - destination:
            host: ms-product.kubestock-production.svc.cluster.local
            port:
              number: 3002
      corsPolicy:
        allowOrigins:
          - exact: "https://kubestock.dpiyumal.me"
        allowMethods:
          - GET
          - POST
          - PUT
          - PATCH
          - DELETE
          - OPTIONS
        allowHeaders:
          - Authorization
          - Content-Type
          - Accept
          - X-Request-ID
        allowCredentials: true
        maxAge: "3600s"

    - match:
        - uri:
            prefix: /api/inventory
      rewrite:
        uri: /
      route:
        - destination:
            host: ms-inventory.kubestock-production.svc.cluster.local
            port:
              number: 3003
      corsPolicy:
        allowOrigins:
          - exact: "https://kubestock.dpiyumal.me"
        allowMethods:
          - GET
          - POST
          - PUT
          - PATCH
          - DELETE
          - OPTIONS
        allowHeaders:
          - Authorization
          - Content-Type
          - Accept
          - X-Request-ID
        allowCredentials: true
        maxAge: "3600s"

    - match:
        - uri:
            prefix: /api/supplier
      rewrite:
        uri: /
      route:
        - destination:
            host: ms-supplier.kubestock-production.svc.cluster.local
            port:
              number: 3004
      corsPolicy:
        allowOrigins:
          - exact: "https://kubestock.dpiyumal.me"
        allowMethods:
          - GET
          - POST
          - PUT
          - PATCH
          - DELETE
          - OPTIONS
        allowHeaders:
          - Authorization
          - Content-Type
          - Accept
          - X-Request-ID
        allowCredentials: true
        maxAge: "3600s"

    - match:
        - uri:
            prefix: /api/order
      rewrite:
        uri: /
      route:
        - destination:
            host: ms-order-management.kubestock-production.svc.cluster.local
            port:
              number: 3005
      corsPolicy:
        allowOrigins:
          - exact: "https://kubestock.dpiyumal.me"
        allowMethods:
          - GET
          - POST
          - PUT
          - PATCH
          - DELETE
          - OPTIONS
        allowHeaders:
          - Authorization
          - Content-Type
          - Accept
          - X-Request-ID
        allowCredentials: true
        maxAge: "3600s"

    - match:
        - uri:
            prefix: /api/identity
      rewrite:
        uri: /
      route:
        - destination:
            host: ms-identity.kubestock-production.svc.cluster.local
            port:
              number: 3006
      corsPolicy:
        allowOrigins:
          - exact: "https://kubestock.dpiyumal.me"
        allowMethods:
          - GET
          - POST
          - PUT
          - PATCH
          - DELETE
          - OPTIONS
        allowHeaders:
          - Authorization
          - Content-Type
          - Accept
          - X-Request-ID
        allowCredentials: true
        maxAge: "3600s"

    - match:
        - uri:
            exact: /api/gateway/health
      directResponse:
        status: 200
        body:
          string: '{"status":"healthy","gateway":"istio"}'

    - match:
        - uri:
            prefix: /
      route:
        - destination:
            host: frontend.kubestock-production.svc.cluster.local
            port:
              number: 80
